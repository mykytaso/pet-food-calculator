{% extends "base.html" %}
{% load static %}

{% block body %}
<div class="container-fluid">

  <!-- Title and Edit Button -->
  <div class="row justify-content-center" style="margin-top:20px">
    <!-- Main Title Section -->
    <div class="col-auto shadow" style="border-radius: 30px; background-color: #ffffff; padding: 10px;">

      <div class="row justify-content-center align-items-center gap-2">
        <!-- Pet Name -->
        <div class="col-auto m-0 p-0">
          <img src="{% static 'images/' %}{{ pet.pet_icon }}"
          alt="pet food icon"
          style="width: 40px; height: 40px;"
          >
        </div>
        <div class="col-auto m-0 p-0">
          <span class="box-header"
          >
            {{ pet.name }}
          </span>
        </div>
      </div>

      <div class="row justify-content-center align-items-center"
           style="margin: 10px 4px 0 4px; padding: 0 0 0 0;"
      >

        <!-- Add Food -->
        <div class="col-auto m-0 p-0">
          <form hx-post="{% url 'calculator:food_create' %}"
                hx-target="#food-list"
                hx-swap="beforeend">
            {% csrf_token %}
            <input type="hidden" name="pet_id" value="{{ pet.id }}">
            <button class="btn btn-pet-nav"
                    type="submit"
                    style="border-radius: 30px 0 0 30px"
            >
              + Add food
            </button>
          </form>
        </div>

        <!-- Edit Pet -->
        <div class="col-auto m-0 p-0">
          <a href="{% url 'calculator:pet_update' pk=pet.id %}"
             class="btn btn-pet-nav"
             style="border-radius: 0 0 0 0"
          >
            Edit
          </a>
        </div>

        <!-- Calculate Price Button -->
        <div class="col-auto m-0 p-0">
          <form action="{% url 'calculator:calculate_price' pk=pet.id %}"
                method="post"
          >
            {% csrf_token %}
            <input type="hidden" name="calculate_price" value="{{ pet.calculate_price }}">
            <button class="btn btn-pet-nav"
                    type="submit"
                    style="border-radius: 0 30px 30px 0"
            >
              Cost: {{ pet.calculate_price | upper }}
            </button>
          </form>
        </div>

      </div>
    </div>
  </div>

  <!-- Food List -->
  <div class="row justify-content-center font-default" id="food-list">
    {% for food in pet.foods.all %}
      {% include "components/food_form.html" %}
    {% endfor %}
  </div>

  <!-- Result Section -->
  <div class="row justify-content-center font-default mb-5 mt-3">
    <div class="col-auto bg-white rounded-5 box-shadow p-4">

      <table style="font-weight: 700; margin-bottom: 20px; color: var(--dark-color);">
        <tr>
          <td style="padding: 6px 0">Total day energy:</td>
          <td style="padding: 6px 0"><span id="total-kcal" style="padding-left: 10px">0</span></td>
        </tr>
        <tr {% if pet.calculate_price == 'off' %} hidden {% endif %}>
          <td>Total day cost:</td>
          <td><span id="total-cost" style="padding-left: 10px">0.00</span></td>
        </tr>
      </table>

      <!-- Calculate Button -->
      <button class="btn btn-primary w-100" type="button" id="calculate">Calculate</button>

    </div>
  </div>

  <script>
    function calculateTotals() {
      let totalKcal = 0;
      let totalCost = 0;

      document.querySelectorAll('.kcal-per-day').forEach(el => {
        const val = parseFloat(el.textContent);
        if (!isNaN(val)) totalKcal += val;
      });

      document.querySelectorAll('.cost-per-day').forEach(el => {
        const val = parseFloat(el.textContent);
        if (!isNaN(val)) totalCost += val;
      });

      document.getElementById('total-kcal').textContent = totalKcal.toFixed(2) + ' kcal';
      document.getElementById('total-cost').textContent = totalCost.toFixed(2) + ' {{ user.currency }}';
    }

    // Run on page load
    document.addEventListener('DOMContentLoaded', calculateTotals);

    // Run after any HTMX swap (so totals update dynamically)
    document.body.addEventListener('htmx:afterRequest', (evt) => {
      // You can check evt.detail.target if needed
      calculateTotals();
    });
  </script>

</div>
{% endblock %}
