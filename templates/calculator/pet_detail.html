{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid">

  <!-- Title and Edit Button -->
  <div class="row justify-content-center align-items-center">
    <div class="col-auto">
      <h1>{{ pet.name }} </h1>
    </div>
    <div class="col-auto">
      <a href="{% url 'calculator:pet_update' pk=pet.id %}" style="font-size: 30px; color: var(--primary-color);">
        <i class="bi bi-pencil-square"></i>
      </a>
    </div>
  </div>

  <!-- Add Food -->
  <div class="row justify-content-center">
    <div class="col-auto">
      <form hx-post="{% url 'calculator:food_create' %}"
            hx-target="#food-list"
            hx-swap="beforeend">
        {% csrf_token %}
        <input type="hidden" name="pet_id" value="{{ pet.id }}">
        <button class="btn btn-primary" type="submit">Add food</button>
      </form>
    </div>
  </div>

  <!-- Food List -->
  <div class="row justify-content-center font-default" id="food-list">
    {% for food in pet.foods.all %}
      {% include "includes/food_form.html" %}
    {% endfor %}
  </div>

  <!-- Calculate Button -->
  <div class="row justify-content-center font-default">
    <div class="col-auto">
       <button class="btn btn-primary" type="button" id="calculate">Calculate</button>
    </div>
  </div>

  <!-- Result Section -->
  <div class="row justify-content-center font-default">
    <div class="col-auto">
      <h2>Result</h2>
      Total kcal: <span id="total-kcal">0</span>
      <br>
      Total cost: <span id="total-cost">0.00</span>
    </div>
  </div>

  <script>
    function calculateTotals() {
      let totalKcal = 0;
      let totalCost = 0;

      document.querySelectorAll('.kcal-output').forEach(el => {
        const val = parseFloat(el.textContent);
        if (!isNaN(val)) totalKcal += val;
      });

      document.querySelectorAll('.cost-output').forEach(el => {
        const val = parseFloat(el.textContent);
        if (!isNaN(val)) totalCost += val;
      });

      document.getElementById('total-kcal').textContent = totalKcal.toFixed(2);
      document.getElementById('total-cost').textContent = totalCost.toFixed(2);
    }

    // Run on page load
    document.addEventListener('DOMContentLoaded', calculateTotals);

    // Run after any HTMX swap (so totals update dynamically)
    document.body.addEventListener('htmx:afterSwap', (evt) => {
      // You can check evt.detail.target if needed
      calculateTotals();
    });
  </script>

</div>
{% endblock %}
